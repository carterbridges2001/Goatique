<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goatique - Premium Goat Sales</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">GOATIQUE</div>
            <div class="nav-links">
                <a href="index.html" class="active">Home</a>
                <a href="browse.html">Browse Goats</a>
                <a href="about.html">About</a>
                <a href="contact.html">Contact</a>
            </div>
            <div class="nav-actions">
                <div id="userProfile" class="user-profile" style="display: none;">
                    <span id="userGreeting"></span>
                    <div class="user-dropdown">
                        <a href="account.html">My Account</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    </div>
                </div>
                <a href="login.html" id="loginBtn" class="btn btn-outline">Login</a>
                <a href="browse.html" class="btn btn-primary">Shop Now</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>Premium Quality Goats for Sale</h1>
                <p>Discover our carefully selected, healthy goats for your farm or homestead.</p>
                <div class="hero-buttons">
                    <a href="#goats" class="btn btn-primary">View Goats</a>
                    <a href="#contact" class="btn btn-outline">Contact Us</a>
                </div>
            </div>
        </div>
    </header>

    <!-- New & Featured Goats -->
    <section id="featured" class="featured-goats">
        <div class="container">
            <div class="section-header">
                <h2>New & Featured Goats</h2>
                <a href="browse.html" class="view-all">View All Goats <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="goat-grid" id="featuredGoatsGrid">
                <!-- Loading spinner will be shown here initially -->
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading featured goats...
                </div>
            </div>
        </div>
    </section>
    
    <style>
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .view-all {
            color: #4f46e5;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }
        
        .view-all:hover {
            color: #4338ca;
        }
        
        .view-all i {
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        
        .view-all:hover i {
            transform: translateX(4px);
        }
        
        .loading-spinner {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .loading-spinner i {
            margin-right: 0.5rem;
        }
        
        .sponsored-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            z-index: 1;
        }
    </style>

    <!-- CTA Section -->
    <section class="cta">
        <div class="container">
            <h2>Ready to Start Your Goat Journey?</h2>
            <p>Contact us today to learn more about our available goats and services.</p>
            <a href="#contact" class="btn btn-primary">Get in Touch</a>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>GOATIQUE</h3>
                    <p>Premium quality goats for sale. Healthy, happy, and ready for their forever homes.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="browse.html">Browse Goats</a></li>
                        <li><a href="#about">About Us</a></li>
                        <li><a href="#contact">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Us</h4>
                    <p><i class="fas fa-phone"></i> (555) 123-4567</p>
                    <p><i class="fas fa-envelope"></i> info@goatique.store</p>
                    <p><i class="fas fa-map-marker-alt"></i> 123 Farm Road, Goatville, TX 78901</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Goatique. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs (compat version for better browser support) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7draXchRUCkK1Hut1eD-Km1_Y4f_AtCU",
            authDomain: "goatique-536bd.firebaseapp.com",
            projectId: "goatique-536bd",
            storageBucket: "goatique-536bd.appspot.com",
            messagingSenderId: "63709506575",
            appId: "1:63709506575:web:864e9369dcf7021859077a",
            measurementId: "G-63D52N4Z66"
        };

        // Initialize Firebase
        try {
            // Initialize Firebase if it hasn't been initialized already
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('Firebase initialized successfully');
            } else {
                firebase.app(); // if already initialized, use that one
                console.log('Using existing Firebase instance');
            }

            // Initialize services
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            
            // Enable offline persistence
            db.enablePersistence()
                .catch((err) => {
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code === 'unimplemented') {
                        console.warn('The current browser does not support all of the features required to enable persistence');
                    }
                });
            
            // Make them globally available
            window.firebase = firebase;
            window.auth = auth;
            window.db = db;
            window.storage = storage;
            
            console.log('Firebase services initialized');
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }
    </script>
    
    <!-- Your app's JavaScript -->
    <script src="auth.js"></script>
    
    <!-- Your app's JavaScript -->
    <script src="auth.js"></script>
    
    <script>
        // Fetch featured listings from Firestore
        document.addEventListener('DOMContentLoaded', () => {
            const featuredGrid = document.getElementById('featuredGoatsGrid');
            
            // Function to show error message
            function showError(message) {
                console.error(message);
                if (featuredGrid) {
                    featuredGrid.innerHTML = `
                        <div class="error-message" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>${message}</p>
                            <button onclick="window.location.reload()" class="btn btn-outline" style="margin-top: 1rem;">
                                <i class="fas fa-sync-alt"></i> Try Again
                            </button>
                        </div>`;
                }
            }
            
            // Function to format image URL
            function getImageUrl(imagePath) {
                if (!imagePath) return 'https://via.placeholder.com/400x300?text=No+Image';
                if (imagePath.startsWith('http')) return imagePath;
                if (imagePath.startsWith('gs://')) {
                    const pathParts = imagePath.split('/');
                    const bucket = pathParts[2];
                    const encodedPath = pathParts.slice(3).map(encodeURIComponent).join('/');
                    return `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodedPath}?alt=media`;
                }
                return imagePath;
            }
            
            // Function to create a goat card
            function createGoatCard(goat) {
                const imageUrl = goat.images && goat.images.length > 0 
                    ? getImageUrl(goat.images[0])
                    : 'https://via.placeholder.com/400x300?text=No+Image';
                
                const price = goat.price ? `$${parseFloat(goat.price).toLocaleString()}` : 'Price on Request';
                const location = goat.location || 'Location not specified';
                const breed = goat.breed ? goat.breed.charAt(0).toUpperCase() + goat.breed.slice(1) : 'Breed not specified';
                const listingId = goat.id || ''; // Ensure we have a valid ID or empty string
                
                return `
                    <div class="goat-card">
                        <div class="goat-image" style="background-image: url('${imageUrl}')" 
                             onclick="window.location.href='listing-details.html?id=${listingId}'">
                            ${goat.isSponsored ? '<span class="sponsored-badge">Featured</span>' : ''}
                        </div>
                        <div class="goat-info">
                            <h3>${goat.title || 'Goat for Sale'}</h3>
                            <p class="price">${price}</p>
                            <p class="breed">${breed}</p>
                            <p class="location"><i class="fas fa-map-marker-alt"></i> ${location}</p>
                            <a href="listing-details.html?id=${listingId}" class="btn btn-primary">View Details</a>
                        </div>
                    </div>`;
            }
            
            // Function to fetch and display featured listings
            async function loadFeaturedListings() {
                console.log('1. Starting loadFeaturedListings');
                
                if (!featuredGrid) {
                    console.error('2. Featured grid element not found');
                    return;
                }
                
                try {
                    // Show loading state
                    console.log('3. Setting loading state');
                    featuredGrid.innerHTML = `
                        <div class="loading-spinner" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4f46e5; margin-bottom: 1rem;"></i>
                            <p>Loading featured goats...</p>
                            <p id="debug-status" style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Initializing...</p>
                        </div>`;
                    
                    const debugEl = document.getElementById('debug-status');
                    const updateStatus = (msg) => {
                        console.log('STATUS:', msg);
                        if (debugEl) debugEl.textContent = msg;
                    };
                    
                    updateStatus('Connecting to Firestore...');
                    console.log('4. Before Firestore query');
                    
                    // Test Firestore connection first
                    try {
                        updateStatus('Testing Firestore connection...');
                        await db.collection('listings').limit(1).get();
                        console.log('4.1 Firestore connection test successful');
                    } catch (testError) {
                        console.error('Firestore connection test failed:', testError);
                        throw new Error('Could not connect to the database. Please check your internet connection.');
                    }
                    
                    // First, try to get any active listings (with error handling for Firestore)
                    let snapshot;
                    updateStatus('Fetching listings...');
                    console.log('5. Attempting to fetch listings');
                    
                    try {
                        console.log('5.1 Trying ordered query');
                        updateStatus('Trying ordered query...');
                        snapshot = await Promise.race([
                            db.collection('listings')
                                .limit(4)
                                .get(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Query timeout')), 5000)
                            )
                        ]);
                        console.log('5.2 Ordered query successful', snapshot.size);
                        updateStatus(`Found ${snapshot.size} listings`);
                    } catch (queryError) {
                        console.error('5.3 Ordered query failed, trying simple query:', queryError);
                        updateStatus('Trying alternative query...');
                        
                        try {
                            snapshot = await db.collection('listings')
                                .limit(4)
                                .get({
                                    source: 'cache'
                                });
                            console.log('5.4 Simple query from cache successful', snapshot.size);
                            updateStatus(`Found ${snapshot.size} cached listings`);
                        } catch (simpleQueryError) {
                            console.error('5.5 All queries failed:', simpleQueryError);
                            throw new Error('Unable to load listings. Please check your connection and try again.');
                        }
                    }
                    
                    if (!snapshot) {
                        console.error('6.1 No snapshot returned from query');
                        throw new Error('No data returned from the server');
                    }
                    
                    console.log('6. Query complete, processing', snapshot.size, 'listings');
                    updateStatus(`Processing ${snapshot.size} listings...`);
                    
                    if (snapshot.empty) {
                        console.log('6.2 No listings found in the database');
                        featuredGrid.innerHTML = `
                            <div class="no-listings" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                                <i class="fas fa-kiwi-bird" style="font-size: 2.5rem; color: #e5e7eb; margin-bottom: 1rem;"></i>
                                <h3>No Goats Available</h3>
                                <p>Check back soon for new listings!</p>
                                <div style="margin-top: 1.5rem;">
                                    <a href="create-listing.html" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> List Your Goat
                                    </a>
                                    <button onclick="window.location.reload()" class="btn btn-outline" style="margin-left: 0.5rem;">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>`;
                        return;
                    }
                    
                    // Process and validate listings
                    console.log('7. Processing documents');
                    updateStatus('Processing documents...');
                    
                    const validListings = [];
                    const docPromises = [];
                    
                    // Process each document with error handling for individual docs
                    snapshot.forEach(doc => {
                        try {
                            console.log('7.1 Processing document:', doc.id);
                            const data = doc.data();
                            
                            if (!data) {
                                console.warn('7.2 Document has no data:', doc.id);
                                return;
                            }
                            
                            console.log('7.3 Document data:', { id: doc.id, ...data });
                            
                            // Basic validation - only require that it's an object with some data
                            validListings.push({
                                id: doc.id,
                                title: data.title || 'Goat for Sale',
                                breed: data.breed || 'Mixed breed',
                                price: data.price || 0,
                                location: data.location || 'Location not specified',
                                images: Array.isArray(data.images) ? data.images : [],
                                isSponsored: Boolean(data.isSponsored),
                                ...data
                            });
                            
                        } catch (e) {
                            console.error('7.4 Error processing document:', doc.id, e);
                        }
                    });
                    
                    console.log('8. Processed', validListings.length, 'valid listings');
                    updateStatus(`Processed ${validListings.length} valid listings`);
                    
                    if (validListings.length === 0) {
                        console.warn('8.1 No valid listings after processing');
                        throw new Error('No valid goat listings found in the database');
                    }
                    
                    // Clear and display listings
                    console.log('9. Rendering listings to the page');
                    updateStatus('Rendering listings...');
                    
                    // Clear the grid
                    featuredGrid.innerHTML = '';
                    
                    // Only show max 3 listings
                    const listingsToShow = validListings.slice(0, 3);
                    
                    // Create and append cards
                    listingsToShow.forEach((goat, index) => {
                        try {
                            console.log(`9.1 Rendering goat ${index + 1}/${listingsToShow.length}`, goat.id);
                            const card = document.createElement('div');
                            card.className = 'goat-card';
                            card.innerHTML = createGoatCard(goat);
                            featuredGrid.appendChild(card);
                        } catch (e) {
                            console.error(`Error rendering goat ${index}:`, e);
                        }
                    });
                    
                    console.log('10. Listings rendered successfully');
                    updateStatus('Done!');
                    
                } catch (error) {
                    console.error('Error in loadFeaturedListings:', error);
                    showError(error.message || 'Failed to load featured goats. Please try again later.');
                }
            }
            
            // Wait for Firebase to be ready
            function checkFirebase() {
                console.log('Checking Firebase...');
                if (window.db) {
                    console.log('Firebase is ready, loading listings...');
                    if (featuredGrid) {
                        loadFeaturedListings();
                    }
                } else {
                    console.log('Firebase not ready yet, waiting...');
                    setTimeout(checkFirebase, 500);
                }
            }
            
            // Start checking for Firebase
            checkFirebase();
        });
    </script>
    <script src="app.js"></script>
</body>
</html>
